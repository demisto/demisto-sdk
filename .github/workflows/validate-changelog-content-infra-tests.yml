name: Run content infrastracture tests
on: pull_request

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name:  Get commit hash
        id: get-commit
        run: echo commit=$(git rev-parse HEAD) >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: demisto/content
          path: content


      - name: Setup Poetry
        uses: Gr1N/setup-poetry@v8

      - name: Install demisto-SDK from branch
        run: |
          cd content
          poetry install --with ci
          echo "uninstalling content-master version of demisto-sdk"
          pip uninstall -y demisto-sdk
          echo "uninstalled content-master demisto-sdk"
          echo "installing branch version of demisto-sdk (${{ steps.get-commit.outputs.commit }} )"
          pip install git+https://github.com/demisto/demisto-sdk@${{ steps.get-commit.outputs.commit }}

      - name: Content Unit Tests
        env:
          PYTHONPATH: ${{ github.workspace }}/content
        run: |
          cd content
          poetry run pytest ./Tests/scripts/infrastructure_tests/ -v
          poetry run pytest ./Tests/Marketplace/Tests/ -v
          poetry run pytest ./Tests/tests -v
          poetry run pytest ./Tests/private_build/tests -v
          poetry run pytest Utils -v
