commonfields:
  id: Zoom
  version: -1
name: Zoom
display: Zoom
category: Messaging
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAMAAAC5zwKfAAACYVBMVEVHcEwAT4UAT4UAT4YAf/8A//8AT4UAf78AT4UAT4UAT4UAUYcAT4YAT4YAT48AXIsAT4UAT4UAUIUAUIUAT4UAT4UAVaoAW5EAUIYAWYwAT4UAT4UAT4UAUIgAT4YAUoUAUIYAUIUAT4YAVY0AUIUAT4UAUIUAUocAUYUAT4UAT4UAT4UAUIYAT4UAUIUAT4cAUYUAUIUAUIYAUocAT4UAUIUAT4YAUY4AUIUAUIYAT4UAVYgAT4UAT4UAT4YAVYUAT4UAT4UAT4YAT4cAT4UAT4UAUYYAZpkAWIUAT4UAT4gAbZEAT4UAUIYAT4UAUIUAT4cAUYgAT4UAZpkAT4UAT4UAT4UAVaoAUIUAT4UAWIkAT4UAU4kAUIUAUIUAU4gAT4UAT4UAT4UAVYgAUIUAT4YAVYkAUYUAT4UAU4cAUIYAUIUAT4gAUIYAVYsAT4YAUocAUYUAUIYAUYgAT4UAT4UAT4UAT4UAUYUAU4UAUYgAT4UAVY0AUIUAUIUAT4UAT4cAT4oAVY0AUYcAUIcAUIUAUIYAUIcAUYcAUIUAT4UAT4UAUIUAT4UAX58AT4UAUIUAUIYAT4UAUIYAUIgAT4UAT4UAUIUAT4UAUIUAT4YAT4UAUIYAT4YAUYkAT4UAUYYAUIUAT4UAT4YAT4YAT4YAT4cAUokAT4UAT4YAUIUAT4UAT4YAUIUAT4UAUIoAT4YAT4UAT4UAT4UAT4UAUIUAT4UAT4YAT4UAUYYAT4YAUYUAT4UAT4YAT4UAUoUAT4UAT4UAUIYAT4YAUIcAYokAT4UAT4UA65kA0ZYAu5PCXoiOAAAAx3RSTlMA+nO6AgG5BP799i9wShAL9/uVzNrxAw6JFLv08EmWKLyPmhI/x88+ccjz4WjtmU1F76VEoFbXGdKMrh71+K0qoZODIMuzSAoXni0H4HnjfnccQwXDjT0Gi/wa5zSCaSvBsWMPb9EnLMoxe3hHOSG+Ilh/S1BnzvJULjimCayy6UAwG1VPta91UVLNgJvZCNBcRuVsPIbb37BllNjCfTLsbrjukKejYCVtqb/5aqiXI9W0tnad4utdt2HEa1ro5EHWpBOBYg3JeEoS2QAAA5lJREFUGBmtwQN7Y0sABuAvbZKT1Ha3tt2ubdu2vXu517Zt27a+TH/VbXgmaTIz53nyvtDaV1+JdDrxHVvzkD43D5BsyUe6bKxmUP0qJNM2Y/Pxud9bMHd5DsNmlmGa/E8ZsvgumHqikFHzPUhgVTGipBxmun20LUCCw4zZAiPtjPMs4r3MmGvbYGA9E6yD7CwlN0FvPac5CckDlLRBK4dJPAxbDiXvQ+c9H5OZQMwW2lZDJ7eQyQ1vQsR+2j6ARnYnU6nKQ8gdtA1Co6mLqXX1AXBf72GUa6EbGmuotCvTu4tRBcOfQ+sATQ2cqoSBF2go6xiMtNNQA8zkH6GZ0zBU/mLFYEcBtbbCiVtrM6lxEA6NVFOpHk6d9lPpbjjVSKWCvXBoHzUyFyG1vuFzM3Yi3rfUqL5/E5Jzv8spz+chjpdao7VIag9D3kAcLw14szHd7h0MGfVAVkITvj/PI4H1OCNyITlPQ67eDYjTzqirFmy9NDZnwRhsy0sZsw4xzX46kDVRiahHaPNleBD2+wDJSSGZpNK1v8sRstJP2StDFoDsXh+niIBEUOM/hNzLBDWtD/UwTAQkghr/IGgrFURAIqg2WoagzVQQAYmg2nUELaWKCEgEla56EFRMFRGQCCpdQtBlKomARFClA0GecSqJgERQZSOCLlBNBCSCCucQZJVQTQQkggpnEHSFGiIgEQx76nhrDRPch5BiaoiARHCKv6gOgNW/n7LCOoT8e7GUSpNCMkmy5xmEeTJ8tBUh6q+K2XTA34yYPYx5qxK25Q0FNFYEmzXOqJ8RZ2eRi2Z8syDpY8RiNxIsmu+niSOQuR9liCsb0638iga+RJwMhpxCUv1fUGsJ4jSt5ZRGpGBldFKjBPHOznjzmyGkNusHahyFQ1eyqPQZnHqQSv4n4VQVlTovwKGD1Mi89BicaKZWVsstFd35MLSUZoqXwcxLNJQBI699TENzYWDs4mya+hBadYOFjFp9YMlaKuVAw5rYwagb93gA1HYxtefKoeaeyRjfGYTkeZlK6TxofE2bFxHWCibn6oeG+zfatiOmgsn4foHOPEqehu1VJrEXWkOU5EKyhtPkQO9OSjZAdpIJDsOAVcOYccRbSJnvExjZzphuJGigzf8jzBz6gxG3u5HAs4JRrhGYGmthkK9xFaYpu41hWbkwVzbyTsdHb59AMtsyGVTahnRZ9hPJ13cjfQ4V89djSKcm71Ho/A9KDXs8/9v7cAAAAABJRU5ErkJggg==
description: Use the Zoom integration manage your Zoom users and meetings
detaileddescription: "detaileddescription\n\n---\n[View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/zoom)"
configuration:
- display: ""
  name: apiKey
  defaultvalue: ""
  type: 4
  required: true
- display: ""
  name: apiSecret
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |
    // pack version: 1.0.3
    var server = params.url.replace(/[\/]+$/, '') + '/' + params.apiVersion + '/';

    var doReq = function(method, path, parameters, cookies) {
        var result = http(
            server + path + (method === 'GET' && parameters ? encodeToURLQuery(parameters) : ''),
            {
                Headers: {'Content-Type': ['application/json'], 'Accept': ['application/json']},
                Method: method,
                Body: method == 'POST' && parameters ? JSON.stringify(parameters) : '',
                Username: params.accessID,
                Password: params.accessKey,
                Cookies: cookies
            },
            params.insecure,
            params.useproxy
        );
        if (result.StatusCode < 200 || result.StatusCode > 299) {
            var errObj;
            try {
                errObj = JSON.parse(result.Body);
            } catch (ex) {
                // Ignore this - we will just throw the status code back
            }
            if (errObj) {
                throw 'Status: ' + result.StatusCode + '\nID: ' + errObj.id + '\nCode: ' + errObj.code + '\nMessage: ' + errObj.message;
            }
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode;
        }
        if (result.Body === '') {
            throw 'No content received.';
        }
        var obj;
        try {
            obj = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }
        return {body: result.Body, obj: obj, statusCode: result.StatusCode, cookies: result.Cookies};
    };

    var search = function(query, from, to, limit, offset, timezone, maxTimeToWaitForResults, byReceiptTime, sleep, waitForSearchComplete) {
        var p = {query: query};
        if (from) {
            p.from = from;
        }
        if (to) {
            p.to = to;
        }
        if (timezone) {
            p.timeZone = timezone;
        }
        if (byReceiptTime) {
            p.byReceiptTime = byReceiptTime;
        }
        // Create the job
        var res = doReq('POST', 'search/jobs', p, null);
        try {
            var done = false;
            var stat;
            // Wait for results based on parameters
            for (var i=0; i<maxTimeToWaitForResults / sleep; i++) {
                wait(sleep);
                stat = doReq('GET', 'search/jobs/' + res.obj.id, null, res.cookies);
                if (stat.obj.state === 'DONE GATHERING RESULTS' || (!waitForSearchComplete && stat.obj.messageCount > (offset + 1) * limit)) {
                    done = true;
                    break;
                }
                if (stat.obj.state === 'CANCELLED') {
                    throw 'Job ' + res.obj.id + ' was cancelled';
                }
            }
            if (done) {
                var results = {};
                if (stat.obj.messageCount > 0) {
                    var msg = doReq('GET', 'search/jobs/' + res.obj.id + '/messages', {offset: offset, limit: limit}, res.cookies);
                    results.messages = msg.obj.messages.map(function(m) {return m.map;});
                }
                if (stat.obj.recordCount > 0) {
                    var rec = doReq('GET', 'search/jobs/' + res.obj.id + '/records', {offset: offset, limit: limit}, res.cookies);
                    results.records = rec.obj.records.map(function(m) {return m.map;});
                }
                return results;
            }
            throw 'Timeout while waiting for job ' + res.obj.id;
        } finally {
            try {
                doReq('DELETE', 'search/jobs/' + res.obj.id, null, res.cookies);
            } catch (ex) {
                logInfo('SumoLogic error deleting job - ' + ex);
            }
        }
    };

    var a2i = function(v, d) {
        return v ? parseInt(v) : d;
    };

    var defaultLimit = 100, defaultSleep = 3, defaultTimeout = 180, defaultSearchTimeout = 10;

    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            doReq('GET', 'collectors', {limit: '3'}, null);
            return 'ok';
        case 'fetch-incidents':
            if (!params.fetchQuery) {
                throw 'No fetch query defined, not doing SumoLogic fetch';
            }
            var now = (new Date()).getTime();
            var lastRun = getLastRun();
            if (!lastRun || !lastRun.time) {
                lastRun = {time: now - parseInt(params.firstFetch) * 1000};
                setLastRun({time: now});
            }

            if (params.fetchDelay) {
                if (now < lastRun.time + parseInt(params.fetchDelay) * 1000) {
                    return JSON.stringify([]);
                }
            }

            var s = search(params.fetchQuery, lastRun.time, now, a2i(params.limit, defaultLimit), 0, params.timeZone, a2i(params.maxTimeout, 180), false,
                a2i(params.sleepBetweenChecks, defaultSleep), params.fetchRecords);
            var incidents = [];

            if (!params.fetchRecords && s.messages) {
                for (var i=0; i<s.messages.length; i++) {
                    var incident = {name: 'Incident from SumoLogic' + s.messages[i]._messageid,
                        details: s.messages[i]._raw, labels: [], rawJSON: JSON.stringify(s.messages[i])};
                    var props = Object.getOwnPropertyNames(s.messages[i]);
                    for (var j=0; j<props.length; j++) {
                        if (props[j] !== '_raw') {
                            incident.labels.push({type: props[j], value: s.messages[i][props[j]]});
                        }
                    }
                    incidents.push(incident);
                }
            }

            if (params.fetchRecords && s.records) {
                for (var i=0; i<s.records.length; i++) {
                    var incident = {name: 'Incident from SumoLogic',
                        details: JSON.stringify(s.records[i]), labels: [], rawJSON: JSON.stringify(s.records[i])};
                    var props = Object.getOwnPropertyNames(s.records[i]);
                    for (var j=0; j<props.length; j++) {
                        if (props[j] !== '_raw') {
                            incident.labels.push({type: props[j], value: s.records[i][props[j]]});
                        }
                    }
                    incidents.push(incident);
                }
            }
            setLastRun({time: now});
            return JSON.stringify(incidents);
        case 'search':
            query = args.query
            var httpIndex = query.indexOf('http')
            if (httpIndex != -1) {
                var httpSubstring = query.substring(httpIndex)
                var whitespaceIndex = httpSubstring.indexOf(' ')
                var url = httpSubstring.substring(0, whitespaceIndex)
                url = url.replace(/=/g, '\\\\=')
                var beforeHttp = query.substring(0, httpIndex)
                var afterWhitespace = query.substring(httpIndex + whitespaceIndex)
                query = beforeHttp + url + afterWhitespace
            }
            var headers = 'headers' in args ? argToList(args.headers) : undefined;
            var waitForSearchComplete = args.waitForSearchComplete == 'true';
            var s = search(query, args.from, args.to, a2i(args.limit, defaultLimit), a2i(args.offset, 0), args.timezone,
                a2i(args.maxTimeToWaitForResults, defaultSearchTimeout) * 60, args.byReceiptTime, a2i(params.sleepBetweenChecks, defaultSleep),
                waitForSearchComplete);
            var md = '';
            var ec = {};
            if (s.messages && s.messages.length > 0) {
                md = tableToMarkdown('SumoLogic Search Messages', s.messages, headers) + '\n';
                ec.Search = {Messages: s.messages.length > defaultLimit ? s.messages.slice(0, defaultLimit) : s.messages};
            }
            if (s.records && s.records.length > 0) {
                md += tableToMarkdown('SumoLogic Search Records', s.records, headers);
                ec.Search = {Records: s.records.length > defaultLimit ? s.records.slice(0, defaultLimit) : s.records};
            }
            if (!md) {
                md = 'No results found';
            }
            return {Type: entryTypes.note, Contents: s, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        default:
            return {Type: entryTypes.error, Contents: 'Unknown command - ' + command, ContentsFormat: formats.text};
    }
  type: javascript
  commands:
  - name: zoom-create-user
    arguments:
    - name: first_name
      required: true
      description: First name of the new user
    - name: last_name
      required: true
      description: Last name of the new user
    - name: email
      required: true
      description: The email of the new user
    - name: user_type
      auto: PREDEFINED
      predefined:
      - Basic
      - Pro
      - Corporate
      description: The type of the newly created user
      defaultValue: Basic
    outputs:
    - contextPath: Zoom.User.id
      description: The ID of the created user
      type: string
    - contextPath: Zoom.User.first_name
      description: First name of the created user
      type: string
    - contextPath: Zoom.User.last_name
      description: Last name for the created user
      type: string
    - contextPath: Zoom.User.email
      description: Email of the created user
      type: string
    - contextPath: Zoom.User.created_at
      description: Created date of the user
      type: date
    - contextPath: Zoom.User.type
      description: The type of the user
      type: number
    description: Create a new user in zoom account
    execution: true
  - name: zoom-create-meeting
    arguments:
    - name: type
      required: true
      default: true
      auto: PREDEFINED
      predefined:
      - Instant
      - Scheduled
      description: The type of the meeting
      defaultValue: Instant
    - name: user
      required: true
      description: email address or id of user for meeting
    - name: topic
      required: true
      description: The topic of the meeting
    - name: auto-record-meeting
      auto: PREDEFINED
      predefined:
      - "yes"
      - "no"
      description: 'Record zoom meeting? '
      defaultValue: "no"
    - name: start-time
      description: Meeting start time. When using a format like “yyyy-MM-dd’T'HH:mm:ss'Z’”,
        always use GMT time. When using a format like “yyyy-MM-dd’T'HH:mm:ss”, you
        should use local time and you will need to specify the time zone. Only used
        for scheduled meetings and recurring meetings with fixed time.
    - name: timezone
      description: 'Timezone to format start_time. For example, “America/Los_Angeles”.
        For scheduled meetings only. '
    outputs:
    - contextPath: Zoom.Meeting.join_url
      description: Join url for the meeting
      type: string
    - contextPath: Zoom.Meeting.id
      description: Meeting id of the new meeting that is created
      type: string
    - contextPath: Zoom.Meeting.start_url
      description: The URL to start the meeting
      type: string
    description: Create a new zoom meeting (scheduled or instant)
  - name: zoom-fetch-recording
    arguments:
    - name: meeting_id
      required: true
      description: Meeting id to get the recording
    outputs:
    - contextPath: File.SHA256
      description: Attachment's SHA256
    - contextPath: File.SHA1
      description: Attachment's SHA1
    - contextPath: File.MD5
      description: Attachment's MD5
    - contextPath: File.Name
      description: Attachment's Name
    - contextPath: File.Info
      description: Attachment's Info
    - contextPath: File.Size
      description: Attachment's Size (In Bytes)
    - contextPath: File.Extension
      description: Attachment's Extension
    - contextPath: File.Type
      description: Attachment's Type
    - contextPath: File.EntryID
      description: Attachment's EntryID
    - contextPath: File.SSDeep
      description: Attachment's SSDeep hash
    description: Get meeting record and save as file in the warroom
  - name: zoom-list-users
    arguments:
    - name: status
      default: true
      auto: PREDEFINED
      predefined:
      - active
      - inactive
      - pending
      description: Which status of users to list
      defaultValue: active
    - name: page-size
      description: Number of users to return. Max 300.
      defaultValue: "30"
    - name: page-number
      description: Which page of results to return
      defaultValue: "1"
    outputs:
    - contextPath: Zoom.Metadata.Count
      description: Total page count available
      type: number
    - contextPath: Zoom.Metadata.Number
      description: Current page number
      type: number
    - contextPath: Zoom.Metadata.Size
      description: Number of results in current page
      type: number
    - contextPath: Zoom.Metadata.Total
      description: Total number of records
      type: number
    - contextPath: Zoom.User.id
      description: ID of the user
      type: string
    - contextPath: Zoom.User.first_name
      description: First name of user
      type: string
    - contextPath: Zoom.User.last_name
      description: Last name of user
      type: string
    - contextPath: Zoom.User.email
      description: Email of user
      type: string
    - contextPath: Zoom.User.type
      description: Type of user
      type: number
    - contextPath: Zoom.User.created_at
      description: Date when user was created
      type: date
    - contextPath: Zoom.User.dept
      description: Department for user
      type: string
    - contextPath: Zoom.User.verified
      description: Is the user verified
      type: number
    - contextPath: Zoom.User.last_login_time
      description: Last login time of the user
      type: date
    - contextPath: Zoom.User.timezone
      description: Default timezone for the user
      type: string
    - contextPath: Zoom.User.pmi
      description: PMI of user
      type: string
    - contextPath: Zoom.User.group_ids
      description: Groups user belongs to
      type: string
    description: List the existing users
  - name: zoom-delete-user
    arguments:
    - name: user
      required: true
      default: true
      description: The user ID or email to delete
    - name: action
      auto: PREDEFINED
      predefined:
      - disassociate
      - delete
      description: The action to take
      defaultValue: disassociate
    description: Delete a user from Zoom
    execution: true
  dockerimage: demisto/pyjwt:1.0
  runonce: false
